<?xml version="1.0" encoding="utf-8" ?>

<odoo>
<data>

<template id="web_nfcpurchase_purchase_event" name="NfcPurchase Purchase Event View">
	<html>
		<head>
            <meta charset="UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
            <title>Purchase Event</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
            <script
                src="https://code.jquery.com/jquery-3.7.1.min.js"
                integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
                crossorigin="anonymous"/>
            <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'/>
            <style>
                section {
                    display: none;
                }
            </style>
        </head>
        <body>
            <div class="container mt-4">
                <t t-if="purchase_events">
                    <h1>Purchase Events</h1>

                    <nav class="nav nav-pills nav-fill mt-4">
                        <a class="nav-link" aria-current="page" href="#sectionPurchaseEvents">Purchase Event List</a>
                        <a class="nav-link" href="#sectionOdooPO">Odoo PO Info</a>
                    </nav>

                    <section id="sectionPurchaseEvents">
                        <table class="table table-hover align-middle mt-4">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Purchase Event</th>
                                    <th>Note</th>
                                    <th class="text-end">Cash In</th>
                                    <th class="text-end">Cash Out</th>
                                    <th class="text-end">Cash Balance</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="purchase_events" t-as="pe">
                                    <tr>
                                        <td><span t-esc="pe.date_stamp"/></td>
                                        <td><span t-esc="pe.name"/></td>
                                        <td><span t-esc="pe.note"/></td>
                                        <td class="text-end"><span t-esc="'Rp {:,.2f}'.format(compute_money_in(pe.uniq_id))"/></td>
                                        <td class="text-end"><span t-esc="'Rp {:,.2f}'.format(compute_money_out(pe.uniq_id))"/></td>
                                        <td class="text-end"><span t-esc="'Rp {:,.2f}'.format(compute_balance(pe.uniq_id))"/></td>
                                        <td class="text-center">
                                            <a type="button" class="btn btn-primary btn-md text-decoration-none"
                                               t-attf-href="/nfcpurchase/view/purchase-event/{{po_odoo.id}}?pe_id={{pe.id}}"
                                               data-toggle="tooltip" title="Purchase"
                                            >
                                                <i class="bx bxs-cart"/>
                                            </a>
                                            <a type="button" class="btn btn-primary btn-md text-decoration-none"
                                               t-attf-href="/nfcpurchase/view/delivery-order/{{pe.id}}"
                                               data-toggle="tooltip" title="Delivery"
                                            >
                                                <i class="bx bxs-car"/>
                                            </a>

                                            <button type="button" class="btn btn-primary btn-md"
                                                    data-bs-toggle="modal" t-attf-data-bs-target="#modalCashier-{{pe.id}}"
                                                    data-toggle="tooltip" title="Cashier"
                                            >
                                                <i class="bx bx-dollar"/>
                                            </button>
                                            <div class="modal modal-lg fade" t-attf-id="modalCashier-{{pe.id}}"
                                                 tabindex="-1" aria-labelledby="modalCashier" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5">Cashier <span t-esc="pe.name"/></h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                                                        </div>
                                                        <div class="modal-body">
                                                            <t t-set="get_pos" t-value="get_purchase_orders(pe.uniq_id)"/>

                                                            <nav class="nav nav-pills nav-fill">
                                                                <a t-attf-class="cashier cashier-{{pe.id}} nav-link" aria-current="page" t-attf-href="#paid-{{pe.id}}">Paid Order</a>
                                                                <a t-attf-class="cashier cashier-{{pe.id}} nav-link" t-attf-href="#unpaid-{{pe.id}}">Unpaid Order</a>
                                                            </nav>

                                                            <section t-attf-id="paid-{{pe.id}}">
                                                                <table class="table table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Order#</th>
                                                                            <th>Farmer Code</th>
                                                                            <th>Farmer</th>
                                                                            <th class="text-end">Total</th>
                                                                            <th>Status</th>
                                                                            <th class="text-center">Paid</th>
                                                                            <th class="text-center">Action</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <t t-foreach="get_pos" t-as="po">
                                                                            <t t-set="farmer" t-value="po.farmer_odoo_true_id"/>
                                                                            <t t-set="len_paid" t-value="0"/>
                                                                            <tr t-if="po.is_paid">
                                                                                <td><span t-esc="po.name"/></td>
                                                                                <td><span t-esc="farmer.code"/></td>
                                                                                <td><span t-esc="farmer.farmer_name"/></td>
                                                                                <td class="text-end"><span t-esc="'Rp. {:,.2f}'.format(compute_grand_total(po))"/></td>
                                                                                <td><span t-esc="po.status"/></td>
                                                                                <td class="text-center"><i class="bx bx-check-square bx-sm"/></td>
                                                                                <td class="text-center">
                                                                                    <a type="button" class="btn btn-primary btn-md text-decoration-none"
                                                                                       t-attf-href="/nfcpurchase/view/purchase-order/{{po.id}}?cashier=cashier"
                                                                                       data-toggle="tooltip" title="Open"
                                                                                    >
                                                                                        <i class="bx bxs-door-open"/>
                                                                                    </a>
                                                                                </td>
                                                                                <t t-set="len_paid" t-value="len_paid + 1"/>
                                                                            </tr>
                                                                            <t t-if="len_notpaid == 0">
                                                                                <tr><td class="text-center" colspan="7">N/A</td></tr>
                                                                            </t>
                                                                        </t>
                                                                    </tbody>
                                                                </table>
                                                            </section>

                                                            <section t-attf-id="unpaid-{{pe.id}}">
                                                                <table class="table table-hover">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Order#</th>
                                                                            <th>Farmer Code</th>
                                                                            <th>Farmer</th>
                                                                            <th class="text-end">Total</th>
                                                                            <th>Status</th>
                                                                            <th class="text-center">Paid</th>
                                                                            <th class="text-center">Action</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <t t-foreach="get_pos" t-as="po">
                                                                            <t t-set="farmer" t-value="po.farmer_odoo_true_id"/>
                                                                            <t t-set="len_notpaid" t-value="0"/>
                                                                            <tr t-if="not po.is_paid">
                                                                                <td><span t-esc="po.name"/></td>
                                                                                <td><span t-esc="farmer.code"/></td>
                                                                                <td><span t-esc="farmer.farmer_name"/></td>
                                                                                <td class="text-end"><span t-esc="'Rp. {:,.2f}'.format(compute_grand_total(po))"/></td>
                                                                                <td><span t-esc="po.status"/></td>
                                                                                <td class="text-center"><i class="bx bx-check-square bx-sm"/></td>
                                                                                <td class="text-center">
                                                                                    <a type="button" class="btn btn-primary btn-md text-decoration-none"
                                                                                       t-attf-href="/nfcpurchase/view/purchase-order/{{po.id}}?cashier=cashier"
                                                                                       data-toggle="tooltip" title="Open"
                                                                                    >
                                                                                        <i class="bx bxs-door-open"/>
                                                                                    </a>
                                                                                </td>
                                                                                <t t-set="len_notpaid" t-value="len_notpaid + 1"/>
                                                                            </tr>
                                                                            <t t-if="len_notpaid == 0">
                                                                                <tr><td class="text-center" colspan="7">N/A</td></tr>
                                                                            </t>
                                                                        </t>
                                                                    </tbody>
                                                                </table>
                                                            </section>

                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="button" class="btn btn-primary btn-md"
                                                    data-bs-toggle="modal" t-attf-data-bs-target="#modalPayments-{{pe.id}}"
                                                    data-toggle="tooltip" title="Payments"
                                            >
                                                <i class="bx bxs-credit-card"/>
                                            </button>

                                            <div class="modal modal-lg fade" t-attf-id="modalPayments-{{pe.id}}"
                                                 tabindex="-1" aria-labelledby="modalCashier" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5">Payments <span t-esc="pe.name"/></h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                                                        </div>
                                                        <div class="modal-body">
                                                            <t t-set="money_entries" t-as="get_money_entries(pe.uniq_id)"/>

                                                            <table class="table table-hover align-middle mt-4">
                                                                <thead>
                                                                    <tr>
                                                                        <th class="text-center">No</th>
                                                                        <th>Name</th>
                                                                        <th>Kind</th>
                                                                        <th>Source</th>
                                                                        <th class="text-end">Amount</th>
                                                                        <th>Type</th>
                                                                        <th>Note</th>
                                                                    </tr>
                                                                </thead>

                                                                <tbody>
                                                                    <t t-set="idx" t-value="1"/>
                                                                    <t t-foreach="money_entries" t-as="money">
                                                                        <tr>
                                                                            <td class="text-center"><span t-esc="idx"/></td>
                                                                            <td><span t-esc="money.number"/></td>
                                                                            <td>
                                                                                <t t-if="money.purchase_order_id">Purchase</t>
                                                                                <t t-else="">Cash</t>
                                                                            </td>
                                                                            <td><span t-esc="po.name"/></td>
                                                                            <td class="text-end"><span t-esc="'Rp {:,.2f}'.format(money.amount)"/></td>
                                                                            <td>
                                                                                <t t-if="money.amount &lt; 0">Credit</t>
                                                                                <t t-else="">Debit</t>
                                                                            </td>
                                                                            <td><span t-esc="money.note"/></td>
                                                                        </tr>
                                                                        <t t-set="idx" t-value="idx + 1"/>
                                                                    </t>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </section>

                    <section id="sectionOdooPO" class="mt-2">
                        <div class="row mt-4">
                            <div class="col-3">
                                <div>Odoo PO#</div>
                                <div><b><t t-esc="po_odoo.name"/></b></div>
                            </div>
                            <div class="col-3">
                                <div>Vendor</div>
                                <div><b><t t-esc="po_odoo.partner_id.display_name"/></b></div>
                            </div>
                            <div class="col-3">
                                <div>Ref</div>
                                <div><b><t t-esc="po_odoo.partner_ref"/></b></div>
                            </div>
                        </div>

                        <table class="table table-hover align-middle mt-4">
                            <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                            </thead>

                            <t t-if="po_odoo.order_line">
                                <tbody>
                                <t t-set="grand_total" t-value="0"/>
                                <t t-foreach="po_odoo.order_line" t-as="line">
                                    <tr>
                                        <td t-esc="line.name"/>
                                        <td class="text-end" t-esc="line.product_qty"/>
                                        <td class="text-end" t-esc="'Rp. {:,.2f}'.format(line.price_unit)"/>
                                        <td class="text-end" t-esc="'Rp. {:,.2f}'.format(line.price_unit * line.product_qty)"/>
                                    </tr>

                                    <t t-set="grand_total" t-value="grand_total + (line.price_unit * line.product_qty)"/>
                                </t>
                                </tbody>

                                <tfoot>
                                <tr>
                                    <th colspan="3">Grand Total</th>
                                    <td class="text-end" t-esc="'Rp. {:,.2f}'.format(grand_total)"/>
                                </tr>
                                </tfoot>
                            </t>
                            <t t-else="">
                                <tr>
                                    <td colspan="4" class="text-center">N/A</td>
                                </tr>
                            </t>
                        </table>
                    </section>
                </t>

                <t t-if="purchase_orders">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a t-attf-href="/nfcpurchase/view/purchase-event/{{purchase_event.purchase_order_odoo_true_id.id}}"
                                    class="text-decoration-none">
                                    <t t-esc="purchase_event.purchase_order_odoo_true_id.name"/>
                                </a>
                            </li>
                            <li class="breadcrumb-item" aria-current="page"><span t-esc="purchase_event.name"/></li>
                        </ol>
                    </nav>

                    <h1>Purchase Event <span t-esc="purchase_event.name"/></h1>

                    <nav class="nav nav-pills nav-fill mt-4">
                        <a class="nav-link" aria-current="page" href="#sectionPurchase">Purchase</a>
                        <a class="nav-link" href="#sectionOdooPO">Odoo PO Info</a>
                    </nav>

                    <section id="sectionPurchase">
                        <table class="table table-hover align-middle mt-4">
                            <thead>
                                <tr>
                                    <th>Order#</th>
                                    <th>Farmer Code</th>
                                    <th>Farmer</th>
                                    <th class="text-end">Total</th>
                                    <th>Status</th>
                                    <th class="text-center">Paid</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="purchase_orders" t-as="po">
                                    <t t-set="farmer" t-value="po.farmer_odoo_true_id"/>
                                    <tr>
                                        <td><span t-esc="po.name"/></td>
                                        <td><span t-esc="farmer.code"/></td>
                                        <td><span t-esc="farmer.farmer_name"/></td>
                                        <td class="text-end"><span t-esc="'Rp. {:,.2f}'.format(compute_grand_total(po))"/></td>
                                        <td><span t-esc="po.status"/></td>
                                        <td class="text-center"><i class="bx bx-check-square bx-sm"/></td>
                                        <td class="text-center">
                                            <a type="button" class="btn btn-primary btn-md text-decoration-none"
                                               t-attf-href="/nfcpurchase/view/purchase-order/{{po.id}}"
                                               data-toggle="tooltip" title="Open"
                                            >
                                                <i class="bx bxs-door-open"/>
                                            </a>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </section>

                    <section id="sectionOdooPO" class="mt-2">
                        <div class="row mt-4">
                            <div class="col-3">
                                <div>Odoo PO#</div>
                                <div><b><t t-esc="po_odoo.name"/></b></div>
                            </div>
                            <div class="col-3">
                                <div>Vendor</div>
                                <div><b><t t-esc="po_odoo.partner_id.display_name"/></b></div>
                            </div>
                            <div class="col-3">
                                <div>Ref</div>
                                <div><b><t t-esc="po_odoo.partner_ref"/></b></div>
                            </div>
                        </div>

                        <table class="table table-hover align-middle mt-4">
                            <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                            </thead>

                            <t t-if="po_odoo.order_line">
                                <tbody>
                                <t t-set="grand_total" t-value="0"/>
                                <t t-foreach="po_odoo.order_line" t-as="line">
                                    <tr>
                                        <td t-esc="line.name"/>
                                        <td class="text-end" t-esc="line.product_qty"/>
                                        <td class="text-end" t-esc="f'Rp {{line.price_unit:,.2f}}'"/>
                                        <td class="text-end" t-esc="f'Rp {{line.price_unit * line.product_qty:,.2f}}'"/>
                                    </tr>

                                    <t t-set="grand_total" t-value="grand_total + (line.price_unit * line.product_qty)"/>
                                </t>
                                </tbody>

                                <tfoot>
                                <tr>
                                    <th colspan="3">Grand Total</th>
                                    <td class="text-end" t-esc="f'Rp {{grand_total:,.2f}}'"/>
                                </tr>
                                </tfoot>
                            </t>
                            <t t-else="">
                                <tr>
                                    <td colspan="4" class="text-center">N/A</td>
                                </tr>
                            </t>
                        </table>
                    </section>
                </t>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"/>
            <script>
                $(document).ready(function() {
                    var firstNav = $('.nav-pills');
                    $(firstNav).each(function(idx, nav) {
                        $(nav).find('.nav-link:first').addClass('active');
                        $($(nav).find('.nav-link').attr('href')).show();
                    });

                    $('.nav-link').on('click', function(e) {
                        e.preventDefault();
                        var thisNavLink = $(this); ;
                        var navToHide = $(thisNavLink).parent().find('.nav-link');
                        navToHide.each(function(idx, nav) {
                            $(nav).removeClass('active');
                            $($(nav).attr('href')).hide();
                        });
                        $(thisNavLink).addClass('active');
                        var target = $(thisNavLink).attr('href');
                        $(target).show();
                    });
                });
            </script>
        </body>
    </html>
</template>

</data>
</odoo>
