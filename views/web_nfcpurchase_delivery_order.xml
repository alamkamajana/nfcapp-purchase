<?xml version="1.0" encoding="utf-8" ?>

<odoo>
<data>

<template id="web_nfcpurchase_delivery_order" name="NfcPurchase Delivery Order View">
	<html>
		<head>
            <meta charset="UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
            <title>Delivery Order</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
            <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"/>
            <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
            <style>
                .breadcrumb-item a {
                    text-decoration: none;
                }
                .modal.fade .modal-dialog {
                    transition: transform 0.1s ease-out;
                }
            </style>
        </head>
        <body>
            <div class="container mt-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a t-attf-href="/nfcpurchase/view/purchase-event/{{purchase_event.purchase_order_odoo_true_id.id}}">
                                <t t-esc="purchase_event.purchase_order_odoo_true_id.name"/>
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Delivery Orders</li>
                    </ol>
                </nav>

                <h1 class="mb-3">Purchase Event <span t-esc="purchase_event.name"/></h1>

                <table class="table table-hover align-middle mt-4">
                    <thead class="text-uppercase">
                        <tr>
                            <th>Delivery#</th>
                            <th>Sent Date</th>
                            <th>Received Date</th>
                            <th>Origin</th>
                            <th>Destination</th>
                            <th>Driver</th>
                            <th>Vehicle Number</th>
                            <th>Status</th>
                            <th>Note</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        <t t-foreach="delivery_orders" t-as="delivery">
                            <tr>
                                <td><span t-esc="delivery.name"/></td>
                                <td><span t-esc="delivery.sent_date"/></td>
                                <td><span t-esc="delivery.received_date"/></td>
                                <td><span t-esc="delivery.origin"/></td>
                                <td><span t-esc="delivery.destination"/></td>
                                <td><span t-esc="delivery.driver"/></td>
                                <td><span t-esc="delivery.vehicle_number"/></td>
                                <td><span t-esc="delivery.status"/></td>
                                <td><span t-esc="delivery.note"/></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-md btn-primary" data-bs-toggle="modal" t-attf-data-bs-target="#modalDelivery-{{delivery.id}}">
                                        <i class="bx bxs-door-open"/>
                                    </button>
                                    <div class="modal modal-lg fade" t-attf-id="modalDelivery-{{delivery.id}}" tabindex="-1" aria-labelledby="modalDelivery" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h1 class="modal-title fs-5">Delivery <span t-esc="delivery.name"/></h1>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                                                </div>
                                                <div class="modal-body">
                                                    <t t-set="order_lines" t-value="get_order_lines(delivery.uniq_id)"/>

                                                    <nav class="nav nav-pills nav-fill">
                                                        <a class="nav-link active" aria-current="page" t-attf-href="#scanned-{{delivery.id}}">Scanned</a>
                                                        <a class="nav-link" t-attf-href="#unscanned-{{delivery.id}}">Not Scanned</a>
                                                    </nav>

                                                    <section t-attf-id="scanned-{{delivery.id}}">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Order</th>
                                                                    <th>Product</th>
                                                                    <th>Quantity</th>
                                                                    <th>Barcode</th>
                                                                </tr>
                                                            </thead>

                                                            <tbody>
                                                            <t t-foreach="order_lines" t-as="line">
                                                                <t t-set="purchase_order" t-value="get_purchase_order(line.purchase_order_uniq_id)"/>
                                                                <tr t-if="line.delivery_order_id">
                                                                    <td><span t-esc="purchase_order.name"/></td>
                                                                    <td><span t-esc="line.product_odoo_true_id.display_name"/></td>
                                                                    <td><span t-esc="line.qty"/></td>
                                                                    <td><span t-esc="line.barcode"/></td>
                                                                </tr>
                                                            </t>
                                                            </tbody>
                                                        </table>
                                                    </section>

                                                    <section t-attf-id="unscanned-{{delivery.id}}" style="display: none;">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Order</th>
                                                                    <th>Product</th>
                                                                    <th>Quantity</th>
                                                                    <th>Barcode</th>
                                                                </tr>
                                                            </thead>

                                                            <tbody>
                                                            <t t-set="len_unscanned" t-value="0"/>
                                                            <t t-foreach="order_lines" t-as="line">
                                                                <t t-set="purchase_order" t-value="get_purchase_order(line.purchase_order_uniq_id)"/>
                                                                <tr t-if="not line.delivery_order_id">
                                                                    <td><span t-esc="purchase_order.name"/></td>
                                                                    <td><span t-esc="line.product_odoo_true_id.display_name"/></td>
                                                                    <td><span t-esc="line.qty"/></td>
                                                                    <td><span t-esc="line.barcode"/></td>
                                                                    <t t-set="len_unscanned" t-value="len_unscanned + 1"/>
                                                                </tr>
                                                            </t>
                                                            <t t-if="len_unscanned == 0">
                                                                <tr>
                                                                    <td colspan="4" class="text-center">N/A</td>
                                                                </tr>
                                                            </t>
                                                            </tbody>
                                                        </table>
                                                    </section>

                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>


                        </t>
                    </tbody>
                </table>

                </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"/>
            <script>
                $(document).ready(function() {
                    $('.nav-link').on('click', function(e) {
                        e.preventDefault();
                        $('.nav-link').removeClass('active');
                        $('section').hide();
                        $(this).addClass('active');
                        var target = $(this).attr('href');
                        $(target).show();
                    });
                });
            </script>
        </body>
    </html>
</template>

<template id="web_nfcpurchase_delivery_scan" name="NfcPurchase Delivery Scan View">
    <html>
		<head>
            <meta charset="UTF-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
            <title>Scan Delivery</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
            <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"/>
            <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"/>
            <style>
                .modal.fade .modal-dialog {
                    transition: transform 0.1s ease-out;
                }
            </style>
        </head>
        <body>
            <div class="container mt-4">

                <form id="formSubmitDeliveryScan">
                    <table class="align-middle">
                        <input type="hidden" name="csrf_token" t-attf-value="{{ request.csrf_token() }}"/>
                        <tr>
                            <td style="width: 150px;">
                                <label for="barcode" class="form-label">Tag</label>
                            </td>
                            <td style="width: 300px;">
                                <input id="barcode" type="text" name="barcode" class="form-control" required="1"/>
                            </td>
                            <td style="width: 30px;">
                                <button type="button" class="btn btn-md btn-primary ms-1"
                                        data-bs-toggle="modal" data-bs-target="#modalScanner">
                                    <i class="bx bx-scan"/>
                                </button>
                            </td>

                            <div class="modal fade" id="modalScanner" tabindex="-1" aria-labelledby="modalScannerLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-5" id="scannerModalLabel">QR Scanner</h1>
                                            <button type="button" id="closeScannerModal" class="btn-close" data-bs-dismiss="modal" aria-label="Close"/>
                                        </div>
                                        <div class="modal-body" style="height: 450px;">
                                            <select id="cameraSelection" class="form-select mb-3">
                                                <option value="">Select Camera</option>
                                            </select>
                                            <div id="reader" style="width: 100%;"/>
                                        </div>
                                        <div class="modal-footer">
                                            <button id="stopScanBtn" type="button" class="btn btn-transparent" style="display: none;">Stop Scanning</button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </tr>
                        <tr>
                            <td><label for="quantity" class="form-label">Quantity</label></td>
                            <td><input id="quantity" type="number" min="0" name="qty" class="form-control" required="1"/></td>
                            <td/>
                        </tr>
                    </table>

                    <div class="row mt-2" style="max-width: 500px;">
                        <div class="col">
                            <button type="button" id="submitBtn" class="btn btn-sm btn-primary">Submit</button>
                        </div>
                        <div class="col text-end">
                            <button type="button" id="clearInputBtn" class="btn btn-transparent">Clear</button>
                        </div>
                    </div>
                </form>

                <br/>

                <div>
                    <table class="table table-sm table-bordered border-dark align-middle" style="max-width: 500px;">
                        <thead>
                            <tr style="border-bottom: 1px solid black;">
                                <td class="ps-2 pe-2" style="width: 200px;">Delivery</td>
                                <th style="width: 200px;" class="ps-2 pe-2">Tags</th>
                                <th class="text-end ps-2 pe-2">Quantity</th>
                                <th/>
                            </tr>
                        </thead>

                        <tbody id="tableDeliveryScanRecord"/>
                    </table>

                    <div id="container-modal"/>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"/>
            <script>
                $(document).ready(function() {
                    $('#barcode').focus();
                    updateDeliveryScanRecord();

                    $('#clearInputBtn').on('click', function() {
                        $('#barcode').val('');
                        $('#quantity').val('');
                        $('#barcode').focus();
                    })

                    $('#barcode').keypress(function (e) {
                        if ((e.keyCode || e.which) == 13) {
                            $('#quantity').focus();
                            return false;
                        }
                    });
                    $('#quantity').keypress(function (e) {
                        if ((e.keyCode || e.which) == 13) {
                            $('#submitBtn').click();
                            return false;
                        }
                    });

                    $('#submitBtn').click(function(event) {
                        event.preventDefault();

                        let allFieldsFilled = true;

                        $('input[required]').each(function() {
                            if ($(this).val() === '') {
                                allFieldsFilled = false;
                            }
                        });

                        if (allFieldsFilled) {
                            var form = document.querySelector('#formSubmitDeliveryScan');
                            var formData = new FormData(form);
                            $.ajax({
                                url: '/nfcpurchase/scan/submit-delivery/',
                                type: 'POST',
                                processData: false,
                                contentType: false,
                                data: formData,
                                dataType: 'json',
                                success: function(response) {
                                    if (response.success) {
                                        alert('Submitted.');
                                    } else if (response.message) {
                                        alert(response.message);
                                        console.error(response.error);
                                    } else {
                                        alert('Submit Failed.');
                                    }
                                    updateDeliveryScanRecord();
                                    $('#clearInputBtn').click();
                                    $('#barcode').val('');
                                    $('#barcode').focus();
                                    $('#modalScanner').show();
                                    $('#modalScanner').hide();
                                },
                                error: function(error) {
                                    console.error("There was an error with the AJAX request", error);
                                }
                            });
                        } else {
                            alert('Please fill all input!');
                        }
                    });


                    let html5QrcodeScanner = null;

                    $('#modalScanner').on('shown.bs.modal', function() {
                        if (!html5QrcodeScanner) {
                            html5QrcodeScanner = new Html5Qrcode("reader");
                            Html5Qrcode.getCameras().then(cameras => {
                                const cameraSelection = $('#cameraSelection');
                                cameraSelection.empty();

                                cameras.forEach(camera => {
                                    cameraSelection.append(new Option(camera.label, camera.id));
                                });

                                cameraSelection.on('change', handleCameraSelectionChange);

                                if (cameras.length > 0) {
                                    cameraSelection.val(cameras[0].id).trigger('change');
                                }
                            }).catch(err => {
                                console.error('Failed to get cameras', err);
                            });
                        }
                    });

                    const cameraSelection = $('#cameraSelection');
                    cameraSelection.on('change', handleCameraSelectionChange);

                    function startScanner(cameraId) {
                        $('#stopScanBtn').show();
                        html5QrcodeScanner.start(
                            cameraId,
                            {
                                fps: 10,
                                qrbox: 250
                            },
                            onScanSuccess,
                            onScanFailure
                        ).catch(err => {
                            console.error('Failed to start QR scanner', err);
                        });
                    }

                    $('#modalScanner').on('hidden.bs.modal', function () {

                        // if (html5QrcodeScanner) {
                        //     if (html5QrcodeScanner.isScanning) {
                        //         html5QrcodeScanner.stop().then(() => {
                        //             html5QrcodeScanner.clear();
                        //             html5QrcodeScanner = null;
                        //         }).catch(err => {
                        //             console.error('Failed to stop QR scanner', err);
                        //         });
                        //     } else {
                        //         html5QrcodeScanner.clear();
                        //         html5QrcodeScanner = null;
                        //     }
                        // }

                    });

                    function handleCameraSelectionChange() {
                        const selectedCameraId = $('#cameraSelection').val();
                        if (selectedCameraId &amp;&amp; html5QrcodeScanner) {
                            if (html5QrcodeScanner.isScanning) {
                                html5QrcodeScanner.stop().then(() => {
                                    startScanner(selectedCameraId);
                                }).catch(err => {
                                    console.error('Failed to stop QR scanner', err);
                                });
                            } else {
                                startScanner(selectedCameraId);
                            }
                        }
                    }

                    $('#stopScanBtn').on('click', function() {
                        if (html5QrcodeScanner) {
                            if (html5QrcodeScanner.isScanning) {
                                html5QrcodeScanner.stop().then(() => {
                                    html5QrcodeScanner.clear();
                                    html5QrcodeScanner = null;
                                    $('#stopScanBtn').hide();
                                    $('#modalScanner').modal('hide');
                                }).catch(err => {
                                    console.error('Failed to stop QR scanner', err);
                                });
                            } else {
                                html5QrcodeScanner.clear();
                                html5QrcodeScanner = null;
                                $('#stopScanBtn').hide();
                                $('#modalScanner').modal('hide');
                            }
                        }
                    });


                    function onScanSuccess(decodedText, decodedResult) {
                        $('#modalScanner').modal('hide');
                        $('#barcode').val(decodedText);
                        $('#quantity').focus();
                    }

                    function onScanFailure(error) {
                        // console.warn(`Code scan error = ${error}`);
                    }

                /*
                    var html5QrcodeScanner = new Html5QrcodeScanner(
                        "reader", { fps: 10, qrbox: 250 }
                    );

                    $('#modalScanner').on('shown.bs.modal', function() {
                        html5QrcodeScanner.render(
                            function (decodedText) {
                                $('#barcode').val(decodedText);
                                html5QrcodeScanner.clear().then(_ => {
                                    onScanSuccess(decodedText);
                                })
                                .catch(error => {
                                    // Could not stop scanning for reasons specified in `error`.
                                });
                            },
                            function (errorMessage) {

                            }
                        );
                    });
                */

                    function updateDeliveryScanRecord() {
                        $('#tableDeliveryScanRecord').html();
                        $('#container-modal').empty();

                        $.ajax({
                            url: '/nfcpurchase/scan/get-delivery-scan-record/',
                            type: 'GET',
                            dataType: 'json',
                            success: function(response) {
                                if (response.length > 0) {
                                    var recordRows = response.map(function(rec) {
                                        return `
                                            <tr>
                                                <td class="ps-2 pe-2">${rec.delivery_order_name}</td>
                                                <td class="ps-2 pe-2">${rec.barcode}</td>
                                                <td class="text-end ps-2 pe-2">${rec.qty.toFixed(2)}</td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-sm btn-danger"
                                                            data-bs-toggle="modal" data-bs-target="#modal-delete-${rec.id}">
                                                        <i class="bx bxs-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('');
                                    $('#tableDeliveryScanRecord').html(recordRows);

                                    var modals = response.map(function(rec) {
                                        return `
                                            <div class="modal fade" id="modal-delete-${rec.id}" tabindex="-1" aria-labelledby="modalDeleteLabel-${rec.id}" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h1 class="modal-title fs-5">Delete Scan</h1>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <h6>Are you sure you want to delete scan:</h6>
                                                            <div class="ms-4">
                                                                <table>
                                                                    <tr>
                                                                        <td>Delivery</td>
                                                                        <td>: ${rec.delivery_order_name}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Tag</td>
                                                                        <td>: ${rec.barcode}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Quantity</td>
                                                                        <td>: ${rec.qty.toFixed(2)}</td>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                            <button type="button" class="btn btn-danger btn-delete-scan" data-delivery-id="${rec.id}">
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');
                                    $('#container-modal').append(modals);
                                } else {
                                    $('#tableDeliveryScanRecord').html(`<tr><td colspan="4" class="text-center">No Data</td></tr>`);
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('AJAX Error: ' + status + error);
                            }
                        });
                    }

                    $(document).on('click', '.btn-delete-scan', function() {
                        var dsId = $(this).attr('data-delivery-id');
                        var modalDeleteId = '#modal-delete-' + dsId;
                        $.ajax({
                            url: '/nfcpurchase/scan/delete/',
                            data: { ds_id: dsId },
                            dataType: 'json',
                            success: function(response) {
                                if (response.success) {
                                    alert('Scan deleted.');
                                } else {
                                    alert('Delete Failed.');
                                }
                                $(modalDeleteId).modal('hide');
                                $('#barcode').focus();
                                updateDeliveryScanRecord();
                            },
                            error: function(error) {
                                console.error("There was an error with the AJAX request", error);
                                $(modalDeleteId).modal('hide');
                            }
                        });
                    });
                });
            </script>
        </body>
    </html>
</template>

</data>
</odoo>
